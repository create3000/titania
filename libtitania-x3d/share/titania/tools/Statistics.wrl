#VRML V2.0 utf8

EXTERNPROTO RoundedRectangle2D [
  exposedField SFFloat cornerRadius
  exposedField SFVec2f size
  field        SFBool  solid
]
"library/RoundedRectangle2D.x3dv"

PROTO Statistics [
  # Custom fields
  exposedField SFFloat  cornerRadius 5
  exposedField SFFloat  linewidthScaleFactor 1
  exposedField SFVec2f  borderWidth 10 10
  # Required fields
  exposedField MFString string [ ]
  exposedField SFNode   fontStyle NULL
]
{
  Group {
    children [
      DEF Background Transform {
        children [
          Shape {
            appearance Appearance {
              material DEF BackgroundMaterial Material {
                diffuseColor 0 0 0
                transparency 0.5
              }
            }
            geometry DEF BackgroundGeometry RoundedRectangle2D {
              cornerRadius IS cornerRadius
            }
          }
          Shape {
            appearance Appearance {
              fillProperties FillProperties {
                filled FALSE
                hatched FALSE
              }
              lineProperties LineProperties {
                linewidthScaleFactor IS linewidthScaleFactor
              }
              material DEF BorderMaterial Material {
                diffuseColor 1 1 1
              }
            }
            geometry USE BackgroundGeometry
          }
        ]
      }
      DEF Statistics Transform {
        children Shape {
          appearance Appearance {
            material DEF TextMaterial Material {
              diffuseColor 1 1 1
            }
          }
          geometry DEF Text Text {
            string IS string
            fontStyle IS fontStyle
          }
        }
      }
    ]
  }

  DEF NotificationScript Script {
    eventIn      SFVec2f set_textBounds
    exposedField SFFloat cornerRadius IS cornerRadius
    exposedField SFFloat linewidthScaleFactor IS linewidthScaleFactor
    exposedField SFVec2f borderWidth IS borderWidth
    field        SFNode  statistics USE Statistics
    field        SFNode  background USE Background
    field        SFNode  geometry USE BackgroundGeometry
    field        SFNode  text USE Text

    url "vrmlscript:

function set_textBounds (value, time)
{
	var bounds = value .add (borderWidth .multiply (2));

	statistics .translation = new SFVec3f (borderWidth .x, borderWidth .y, 0);

	var translation         = bounds .divide (2);
	background .translation = new SFVec3f (Math .floor (translation .x), Math .floor (translation .y), 0);

	geometry .size = bounds .add (new SFVec2f (cornerRadius + 1, cornerRadius + 1));

	// Align background line geometry on whole pixel

	if (is_odd (linewidthScaleFactor))
	{
		if (is_even (geometry .size .x))
			++ geometry .size .x;
		
		if (is_even (geometry .size .y))
			++ geometry .size .y;
	}
}

function is_even (value)
{
	return ! is_odd (value);
}

function is_odd (value)
{
	return value & 1;
}
"
    directOutput TRUE
  }


  # String

  ROUTE Text.textBounds TO NotificationScript.set_textBounds
}

Background {
  transparency 1
}

OrthoViewpoint { }

LayoutGroup {
  layout Layout {
    align [ "LEFT", "BOTTOM" ]
    offsetUnits "PIXEL"
    sizeUnits "PIXEL"
    size [ 0, 0 ]
    scaleMode "PIXEL"
  }
  children DEF StatisticsTool Statistics {
    fontStyle ScreenFontStyle {
      family "TYPEWRITER"
      pointSize 7.5
      spacing 1.2
      justify [ "BEGIN", "END" ]
    }
  }
}
