#VRML V2.0 utf8

PROTO TransformHandle [
  # required fields
  exposedField SFMatrix4f inverseCameraSpaceMatrix 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0 1
  exposedField SFMatrix4f modelViewMatrix 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0 1
  exposedField SFVec3f    bboxSize 0 0 0
  exposedField SFVec3f    bboxCenter 0 0 0
  exposedField SFNode     transform NULL
]
{
  Group {
    children [
      DEF Lines Transform {
        translation IS bboxCenter
        scale IS bboxSize
        children [
          DEF BBox Shape {
            geometry IndexedLineSet {
              coordIndex [ 0, 1, 2, 3, 0, -1, 4, 5, 6, 7, 4, -1, 0, 4, -1, 3, 7, -1, 1, 5, -1, 2, 6, -1 ]
              coord Coordinate {
                point [ -0.5 0.5 0.5, -0.5 -0.5 0.5, 0.5 -0.5 0.5, 0.5 0.5 0.5, -0.5 0.5 -0.5, -0.5 -0.5 -0.5, 0.5 -0.5 -0.5, 0.5 0.5 -0.5 ]
              }
            }
          }
          DEF Axes Shape {
            geometry IndexedLineSet {
              colorPerVertex FALSE
              coordIndex [ 0, 1, -1, 0, 2, -1, 0, 3, -1 ]
              color Color {
                color [ 1 0 0, 0 1 0, 0 0 1 ]
              }
              coord Coordinate {
                point [ 0 0 0, 0.5 0 0, 0 0.5 0, 0 0 0.5, 0 0 0 ]
              }
            }
          }
        ]
      }
      DEF X Transform {
        translation IS bboxCenter
        scale 0 0 0
        children Transform {
          rotation 0 0 -1 1.5708
          children Shape {
            appearance Appearance {
              material Material {
                diffuseColor 1 0 0
              }
            }
            geometry DEF Arrow Cone {
              height 0.03
              bottomRadius 0.01
            }
          }
        }
      }
      DEF Y Transform {
        translation IS bboxCenter
        scale 0 0 0
        children Transform {
          children Shape {
            appearance Appearance {
              material Material {
                diffuseColor 0 1 0
              }
            }
            geometry USE Arrow
          }
        }
      }
      DEF Z Transform {
        translation IS bboxCenter
        scale 0 0 0
        children Transform {
          rotation 1 0 0 1.5708
          children Shape {
            appearance Appearance {
              material Material {
                diffuseColor 0 0 1
              }
            }
            geometry USE Arrow
          }
        }
      }
    ]
  }

  DEF TransformHandle Script {
    exposedField SFMatrix4f inverseCameraSpaceMatrix IS inverseCameraSpaceMatrix
    exposedField SFMatrix4f modelViewMatrix IS modelViewMatrix
    exposedField SFVec3f    bboxSize IS bboxSize
    exposedField SFNode     transform IS transform
    field        SFNode     x USE X
    field        SFNode     y USE Y
    field        SFNode     z USE Z
    field        SFNode     lines USE Lines
    field        SFNode     arrow USE Arrow

    url "vrmlscript:
function eventsProcessed ()
{
	var translation = new SFVec3f ();
	var rotation    = new SFRotation ();
	var scale       = new SFVec3f ();
	modelViewMatrix .multRight (inverseCameraSpaceMatrix) .getTransform (translation, rotation, scale);

	var distance = translation .length ();
	var offset   = arrow .height / 2 * distance;

	x .children [0] .translation = new SFVec3f (offset + bboxSize .x / 2 * scale .x, 0, 0);
	y .children [0] .translation = new SFVec3f (0, offset + bboxSize .y / 2 * scale .y, 0);
	z .children [0] .translation = new SFVec3f (0, 0, offset + bboxSize .z / 2 * scale .z);

	scale = new SFVec3f (1 / scale .x, 1 / scale .y, 1 / scale .z);
	x .scale = scale;
	y .scale = scale;
	z .scale = scale;

	scale = new SFVec3f (distance, distance, distance)
	x .children [0] .scale = scale;
	y .children [0] .scale = scale;
	z .children [0] .scale = scale;
}
"
  }
}

DEF Handle TransformHandle { }
